import {
  Children,
  cloneElement,
  ReactElement,
  useContext,
  useMemo,
} from 'react';
import flattenChildren from 'react-keyed-flatten-children';

import { isChildSubcomponent, renderNullAndWarnUser } from '../../utils';
import { Box, BoxWithRCAndDomProps } from '../Box';
import { TableContext } from './context';
import { TableRow } from './TableRow';

export type TableBodyProps<RC extends ReactElement | undefined = undefined> =
  BoxWithRCAndDomProps<RC>;

export function TableBody<RC extends ReactElement | undefined = undefined>({
  children,
  rc = <tbody />,
  className,
  testId: testIdProp,
  ...props
}: TableBodyProps<RC>) {
  const { testId } = useContext(TableContext);
  const flattenedChildren = useMemo(
    () => flattenChildren(children),
    [children],
  );
  return (
    <Box
      {...props}
      rc={rc}
      testId={`${testIdProp ?? testId}__tbody`}
      // @TODO: deprecate the use of plain "tbody" class, infavour of
      // the more specific "TableBody" classes
      className={`${className ?? ''} TableBody tbody`}
    >
      {Children.map(flattenedChildren, child => {
        if (isChildSubcomponent(child, TableRow)) {
          return cloneElement(child, { parentNode: 'tbody' });
        }

        return renderNullAndWarnUser(TableBody.displayName);
      })}
    </Box>
  );
}

TableBody.displayName = 'Table.Body';
